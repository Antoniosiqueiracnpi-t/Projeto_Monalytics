name: Diagnóstico Dividendos Futuros

on:
  workflow_dispatch:

jobs:
  diagnostico:
    runs-on: ubuntu-latest
    steps:
      - name: Testar fontes de dividendos futuros
        run: |
          pip install requests pandas
          python3 << 'EOF'
          import requests
          import base64
          import json
          import warnings
          from datetime import datetime
          warnings.filterwarnings('ignore')

          HOJE = datetime.now().strftime('%Y-%m-%d')
          print(f"Data de hoje: {HOJE}")
          print("="*70)

          # ============================================================
          # TESTE 1: API B3 - GetListedCashDividends (já funciona)
          # Verificar se retorna dividendos com data futura
          # ============================================================
          print("\n[TESTE 1] API B3 - GetListedCashDividends")
          print("-"*50)

          tickers_teste = ['VALE', 'PETR', 'ITUB', 'BBAS', 'TAEE']

          for trading_name in ['VALE', 'PETROBRAS', 'ITAUUNIBANCO', 'BRASIL', 'TAESA']:
              params = {"language": "pt-br", "pageNumber": 1, "pageSize": 10, "tradingName": trading_name}
              params_b64 = base64.b64encode(json.dumps(params).encode()).decode()
              url = f"https://sistemaswebb3-listados.b3.com.br/listedCompaniesProxy/CompanyCall/GetListedCashDividends/{params_b64}"
              
              try:
                  r = requests.get(url, timeout=15, verify=False)
                  if r.status_code == 200:
                      data = r.json()
                      divs = data.get('results', [])
                      
                      # Verificar datas
                      futuros = 0
                      for d in divs[:5]:
                          data_ex = d.get('lastDatePriorEx', '')
                          # Converter de DD/MM/YYYY para YYYY-MM-DD
                          try:
                              dia, mes, ano = data_ex.split('/')
                              data_iso = f"{ano}-{mes}-{dia}"
                              if data_iso >= HOJE:
                                  futuros += 1
                                  print(f"  {trading_name}: FUTURO - {data_ex} - R${d.get('valueCash')} ({d.get('corporateAction')})")
                          except:
                              pass
                      
                      if futuros == 0:
                          print(f"  {trading_name}: Nenhum dividendo futuro nos últimos 5")
                  else:
                      print(f"  {trading_name}: Erro {r.status_code}")
              except Exception as e:
                  print(f"  {trading_name}: Erro - {e}")

          # ============================================================
          # TESTE 2: API B3 - Eventos Corporativos (endpoint alternativo)
          # ============================================================
          print("\n[TESTE 2] API B3 - GetListedSupplementCompany")
          print("-"*50)

          # Testar endpoint de eventos corporativos
          for trading_name in ['VALE', 'PETROBRAS']:
              params = {"language": "pt-br", "tradingName": trading_name}
              params_b64 = base64.b64encode(json.dumps(params).encode()).decode()
              url = f"https://sistemaswebb3-listados.b3.com.br/listedCompaniesProxy/CompanyCall/GetListedSupplementCompany/{params_b64}"
              
              try:
                  r = requests.get(url, timeout=15, verify=False)
                  print(f"  {trading_name}: Status {r.status_code}")
                  if r.status_code == 200:
                      data = r.json()
                      print(f"    Keys: {list(data.keys())[:10]}")
              except Exception as e:
                  print(f"  {trading_name}: Erro - {e}")

          # ============================================================
          # TESTE 3: MeusDividendos API (gratuita)
          # ============================================================
          print("\n[TESTE 3] MeusDividendos API")
          print("-"*50)

          for ticker in ['VALE3', 'PETR4', 'ITUB4']:
              url = f"https://meusdividendos.com/api/dividendos/{ticker}"
              try:
                  r = requests.get(url, timeout=10)
                  print(f"  {ticker}: Status {r.status_code}")
                  if r.status_code == 200:
                      data = r.json()
                      print(f"    Tipo: {type(data)}, Exemplo: {str(data)[:200]}")
              except Exception as e:
                  print(f"  {ticker}: Erro - {e}")

          # ============================================================
          # TESTE 4: Investidor10 API
          # ============================================================
          print("\n[TESTE 4] Investidor10")
          print("-"*50)

          for ticker in ['VALE3', 'PETR4']:
              url = f"https://investidor10.com.br/api/dividendos/{ticker.lower()}/"
              try:
                  r = requests.get(url, timeout=10, headers={'User-Agent': 'Mozilla/5.0'})
                  print(f"  {ticker}: Status {r.status_code}")
                  if r.status_code == 200:
                      data = r.json()
                      print(f"    Tipo: {type(data)}, Exemplo: {str(data)[:200]}")
              except Exception as e:
                  print(f"  {ticker}: Erro - {e}")

          # ============================================================
          # TESTE 5: API CVM - Eventos Relevantes
          # ============================================================
          print("\n[TESTE 5] CVM - Eventos Relevantes")
          print("-"*50)

          url = "https://dados.cvm.gov.br/dados/CIA_ABERTA/DOC/IPE/DADOS/"
          try:
              r = requests.get(url, timeout=10)
              print(f"  Status: {r.status_code}")
              if r.status_code == 200:
                  # Listar arquivos disponíveis
                  print(f"  Conteúdo: {r.text[:500]}")
          except Exception as e:
              print(f"  Erro: {e}")

          # ============================================================
          # TESTE 6: Fundamentus (direto, sem finbr)
          # ============================================================
          print("\n[TESTE 6] Fundamentus (direto)")
          print("-"*50)

          for ticker in ['VALE3', 'PETR4']:
              url = f"https://fundamentus.com.br/proventos.php?papel={ticker}"
              try:
                  r = requests.get(url, timeout=10, headers={'User-Agent': 'Mozilla/5.0'})
                  print(f"  {ticker}: Status {r.status_code}")
              except Exception as e:
                  print(f"  {ticker}: Erro - {e}")

          print("\n" + "="*70)
          print("DIAGNÓSTICO CONCLUÍDO")
          print("="*70)
          EOF
