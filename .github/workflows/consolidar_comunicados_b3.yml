name: Atualizar Consolidador de Comunicados B3

on:
  schedule:
    - cron: '0 23 * * *'  # Executa diariamente Ã s 23:00 UTC (20:00 BRT)
  workflow_dispatch:  # Permite execuÃ§Ã£o manual

permissions:
  contents: write

jobs:
  consolidar-noticias:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Verificar arquivos de notÃ­cias
        id: check-noticias
        run: |
          echo "ðŸ“ Verificando arquivos de notÃ­cias individuais..."
          ARQUIVOS=$(find balancos -type f -name "noticias.json" 2>/dev/null | wc -l)
          echo "total_arquivos=$ARQUIVOS" >> $GITHUB_ENV
          
          if [ $ARQUIVOS -gt 0 ]; then
            echo "âœ… Encontrados $ARQUIVOS arquivos de notÃ­cias"
            echo "noticias_exists=true" >> $GITHUB_ENV
          else
            echo "âš ï¸ Nenhum arquivo de notÃ­cias encontrado"
            echo "noticias_exists=false" >> $GITHUB_ENV
          fi
      
      - name: Consolidar notÃ­cias em feed Ãºnico
        if: env.noticias_exists == 'true'
        run: |
          echo "ðŸ“Š Consolidando notÃ­cias das empresas B3..."
          python src/consolidar_noticias.py
      
      - name: Verificar feed consolidado
        if: env.noticias_exists == 'true'
        run: |
          if [ -f "balancos/feed_noticias.json" ]; then
            echo "âœ… Feed consolidado gerado"
            
            # Extrair estatÃ­sticas do feed
            TOTAL_EMPRESAS=$(jq -r '.meta.total_empresas' balancos/feed_noticias.json)
            TOTAL_NOTICIAS=$(jq -r '.meta.total_noticias' balancos/feed_noticias.json)
            DATA_INICIO=$(jq -r '.meta.periodo.inicio' balancos/feed_noticias.json)
            DATA_FIM=$(jq -r '.meta.periodo.fim' balancos/feed_noticias.json)
            
            echo ""
            echo "ðŸ“Š EstatÃ­sticas do feed consolidado:"
            echo "   Total de empresas: $TOTAL_EMPRESAS"
            echo "   Total de notÃ­cias: $TOTAL_NOTICIAS"
            echo "   PerÃ­odo: $DATA_INICIO a $DATA_FIM"
            
            # Top 3 categorias
            echo ""
            echo "ðŸ“ˆ Top 3 categorias:"
            jq -r '.estatisticas.top_categorias[0:3][] | "   \(.categoria): \(.total) notÃ­cias"' balancos/feed_noticias.json
            
            # Top 3 empresas
            echo ""
            echo "ðŸ“ˆ Top 3 empresas:"
            jq -r '.estatisticas.top_empresas[0:3][] | "   \(.ticker): \(.total) notÃ­cias"' balancos/feed_noticias.json
            
            # Tamanho do arquivo
            TAMANHO=$(du -h balancos/feed_noticias.json | cut -f1)
            echo ""
            echo "ðŸ’¾ Tamanho do arquivo: $TAMANHO"
          else
            echo "âš ï¸ Feed consolidado nÃ£o foi gerado"
            exit 1
          fi
      
      - name: ðŸ“ Atualizar timestamp de consolidaÃ§Ã£o
        if: env.noticias_exists == 'true'
        run: |
          mkdir -p site/data
          TIMESTAMP=$(date +%s)000
          DATA=$(TZ='America/Sao_Paulo' date +'%Y-%m-%d')
          HORA=$(TZ='America/Sao_Paulo' date +'%H:%M BRT')
          
          cat > site/data/ultima_consolidacao_noticias.json << EOF
          {
            "timestamp": ${TIMESTAMP},
            "data": "${DATA}",
            "hora": "${HORA}",
            "fonte": "consolidador_noticias_b3",
            "versao": "1.0.0"
          }
          EOF
          
          echo "âœ… Timestamp atualizado: ${TIMESTAMP} (${DATA} ${HORA})"
      
      - name: Commit e Push
        if: env.noticias_exists == 'true'
        run: |
          git config user.name "actions-user"
          git config user.email "actions-user@users.noreply.github.com"
          
          # Verificar se houve mudanÃ§as no feed
          if git diff --quiet balancos/feed_noticias.json; then
            echo "â„¹ï¸ Nenhuma mudanÃ§a no feed consolidado"
            exit 0
          fi
          
          git add balancos/feed_noticias.json
          git add site/data/ultima_consolidacao_noticias.json
          git commit -m "ðŸ“° Atualizar feed consolidado notÃ­cias B3 - $(date +'%Y-%m-%d %H:%M') [skip netlify]"
          git push
          
          echo "âœ… Feed consolidado atualizado e commitado"
      
      - name: Resumo da execuÃ§Ã£o
        if: always()
        run: |
          echo "======================================================================"
          echo "  RESUMO DA CONSOLIDAÃ‡ÃƒO DE NOTÃCIAS B3"
          echo "======================================================================"
          echo "Arquivos individuais encontrados: ${total_arquivos:-0}"
          echo "Feed consolidado: $([ -f balancos/feed_noticias.json ] && echo 'gerado' || echo 'nÃ£o gerado')"
          echo "Timestamp: $([ -f site/data/ultima_consolidacao_noticias.json ] && echo 'atualizado' || echo 'nÃ£o atualizado')"
          echo "======================================================================"
