name: AtualizaÃ§Ã£o DiÃ¡ria de NotÃ­cias

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:
    inputs:
      dias:
        description: 'Dias retroativos (padrÃ£o: 1)'
        required: false
        default: '1'
        type: string

permissions:
  contents: write

jobs:
  noticias:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas finbr
      
      - name: Capturar NotÃ­cias do Dia
        run: |
          DIAS=${{ inputs.dias || '1' }}
          python src/capturar_noticias.py --modo quantidade --quantidade 0 --dias ${DIAS}

      - name: ðŸ“ Atualizar timestamp
        run: |
          mkdir -p site/data
          
          TIMESTAMP=$(date +%s)000
          DATA=$(TZ='America/Sao_Paulo' date +'%Y-%m-%d')
          HORA=$(TZ='America/Sao_Paulo' date +'%H:%M BRT')
          
          cat > site/data/ultima_atualizacao.json << EOF
          {
            "timestamp": ${TIMESTAMP},
            "data": "${DATA}",
            "hora": "${HORA}",
            "fonte": "noticias_diarias",
            "versao": "1.0.0"
          }
          EOF
          
          echo "âœ… Timestamp atualizado: ${TIMESTAMP} (${DATA} ${HORA})"
      
      - name: Commit e push
        run: |
          git config user.name "actions-user"
          git config user.email "actions-user@users.noreply.github.com"
          
          if [ -z "$(git status --porcelain)" ]; then
            echo "âœ… Nenhuma notÃ­cia nova"
            exit 0
          fi
          
          git add balancos/*/noticias.json
          git add site/data/ultima_atualizacao.json
          git commit -m "NotÃ­cias diÃ¡rias: $(date +'%Y-%m-%d') [skip netlify]"
          git push
