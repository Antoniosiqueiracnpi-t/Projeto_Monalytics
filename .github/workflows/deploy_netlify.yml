name: Deploy Netlify

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONTROLE DE CONCORRÃŠNCIA
# Garante que apenas um deploy rode por vez, evitando conflitos
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
concurrency:
  group: netlify-deploy
  cancel-in-progress: false  # Aguarda o anterior terminar

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TRIGGERS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
on:
  # Manual via GitHub Actions
  workflow_dispatch:
  
  # AutomÃ¡tico via schedule
  schedule:
    - cron: '0 13 * * 1-5'   # 10h BRT (apÃ³s abertura - seg a sex)
    - cron: '30 18 * * 1-5'  # 15h30 BRT (apÃ³s fechamento - seg a sex)
    - cron: '0 23 * * *'     # 20h BRT (deploy noturno - todos os dias)

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# JOBS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Timeout de seguranÃ§a
    
    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1. CHECKOUT DO REPOSITÃ“RIO
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¥ Checkout RepositÃ³rio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # HistÃ³rico completo para rebase
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2. VALIDAÃ‡ÃƒO DE CONFIGURAÃ‡Ã•ES
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ” Validar Secrets e ConfiguraÃ§Ãµes
        run: |
          echo "ğŸ” Validando configuraÃ§Ãµes..."
          
          # Valida secret do Netlify
          if [ -z "${{ secrets.NETLIFY_BUILD_HOOK }}" ]; then
            echo "âŒ ERRO CRÃTICO: Secret NETLIFY_BUILD_HOOK nÃ£o configurado!"
            echo ""
            echo "ğŸ“‹ Como configurar:"
            echo "   1. VÃ¡ em Settings â†’ Secrets and variables â†’ Actions"
            echo "   2. Clique em 'New repository secret'"
            echo "   3. Nome: NETLIFY_BUILD_HOOK"
            echo "   4. Valor: URL do build hook do Netlify"
            echo ""
            exit 1
          fi
          
          # Valida estrutura de diretÃ³rios
          if [ ! -d "site" ]; then
            echo "âŒ ERRO: DiretÃ³rio 'site' nÃ£o encontrado!"
            exit 1
          fi
          
          echo "âœ… Todas as configuraÃ§Ãµes validadas com sucesso"
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3. AGUARDAR WORKFLOWS ATIVOS
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ• Aguardar Workflows de Dados Finalizarem
        run: |
          echo "â³ Verificando workflows ativos..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          TIMEOUT=600  # 10 minutos de timeout
          ELAPSED=0
          INTERVAL=30  # Verifica a cada 30 segundos
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            # Lista workflows em execuÃ§Ã£o (exceto este)
            RUNNING=$(gh run list \
              --status in_progress \
              --json name,databaseId,startedAt \
              --jq '[.[] | select(.name != "Deploy Netlify")] | length' \
              2>/dev/null || echo "0")
            
            if [ "$RUNNING" -eq 0 ]; then
              echo "âœ… Nenhum workflow ativo detectado"
              echo "âœ… Seguro para prosseguir com deploy"
              break
            fi
            
            echo "â³ Aguardando $RUNNING workflow(s) finalizar(em)..."
            echo "   Tempo decorrido: ${ELAPSED}s / ${TIMEOUT}s"
            
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done
          
          if [ $ELAPSED -ge $TIMEOUT ]; then
            echo "âš ï¸  AVISO: Timeout aguardando workflows"
            echo "âš ï¸  Prosseguindo mesmo assim..."
          fi
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4. ATUALIZAR TIMESTAMP
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“ Gerar Timestamp de Deploy
        id: timestamp
        run: |
          echo "ğŸ• Gerando timestamp de deploy..."
          
          # Criar diretÃ³rio se nÃ£o existir
          mkdir -p site/data
          
          # Backup do arquivo anterior (se existir)
          if [ -f "site/data/ultima_atualizacao.json" ]; then
            cp site/data/ultima_atualizacao.json site/data/ultima_atualizacao.json.bak
          fi
          
          # Gerar timestamp Unix em milissegundos
          TIMESTAMP=$(date +%s)000
          DATA=$(TZ='America/Sao_Paulo' date +'%Y-%m-%d')
          HORA=$(TZ='America/Sao_Paulo' date +'%H:%M BRT')
          ISO=$(TZ='America/Sao_Paulo' date -Iseconds)
          
          # Determinar tipo de deploy
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TIPO="manual"
          else
            TIPO="automatico"
          fi
          
          # Criar JSON com timestamp
          cat > site/data/ultima_atualizacao.json << EOF
          {
            "timestamp": ${TIMESTAMP},
            "data": "${DATA}",
            "hora": "${HORA}",
            "deploy": "${TIPO}",
            "versao": "1.0.0",
            "trigger": "${{ github.event_name }}",
            "iso": "${ISO}",
            "run_id": "${{ github.run_id }}",
            "commit_sha": "${{ github.sha }}"
          }
          EOF
          
          echo "âœ… Timestamp criado com sucesso!"
          echo ""
          echo "ğŸ“‹ Detalhes do deploy:"
          echo "   â€¢ Timestamp: ${TIMESTAMP}"
          echo "   â€¢ Data/Hora: ${DATA} ${HORA}"
          echo "   â€¢ Tipo: ${TIPO}"
          echo "   â€¢ Trigger: ${{ github.event_name }}"
          echo "   â€¢ Run ID: ${{ github.run_id }}"
          echo ""
          echo "ğŸ“„ ConteÃºdo do arquivo:"
          cat site/data/ultima_atualizacao.json
          
          # Exporta para prÃ³ximos steps
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "data_hora=${DATA} ${HORA}" >> $GITHUB_OUTPUT
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 5. COMMIT E PUSH COM RETRY INTELIGENTE
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ’¾ Commit e Push (Com Retry AutomÃ¡tico)
        run: |
          echo "ğŸ’¾ Iniciando processo de commit e push..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Configurar Git
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Adicionar arquivo
          git add site/data/ultima_atualizacao.json
          
          # Verificar se hÃ¡ mudanÃ§as
          if git diff --staged --quiet; then
            echo "â„¹ï¸  Nenhuma mudanÃ§a detectada no timestamp"
            echo "â„¹ï¸  Arquivo jÃ¡ estava atualizado, pulando commit"
            exit 0
          fi
          
          # Criar commit
          COMMIT_MSG="ğŸ• Atualizar timestamp de deploy [skip ci]"
          git commit -m "$COMMIT_MSG"
          echo "âœ… Commit criado: $COMMIT_MSG"
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # RETRY LOGIC COM PULL + REBASE
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          MAX_ATTEMPTS=5
          ATTEMPT=1
          SUCCESS=false
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo ""
            echo "ğŸ”„ Tentativa $ATTEMPT de $MAX_ATTEMPTS"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            
            # Fetch Ãºltimas mudanÃ§as
            echo "ğŸ“¥ Fetching origin/main..."
            git fetch origin main
            
            # Tenta rebase
            echo "ğŸ”€ Aplicando rebase..."
            if git rebase origin/main; then
              echo "âœ… Rebase aplicado com sucesso"
            else
              echo "âš ï¸  Conflito detectado durante rebase"
              echo "ğŸ”§ Resolvendo conflito automaticamente..."
              
              # Aborta rebase
              git rebase --abort 2>/dev/null || true
              
              # EstratÃ©gia: reset soft + reaplica commit
              git reset --soft origin/main
              git add site/data/ultima_atualizacao.json
              git commit -m "$COMMIT_MSG"
              
              echo "âœ… Conflito resolvido automaticamente"
            fi
            
            # Tenta push
            echo "â¬†ï¸  Executando push..."
            if git push origin main; then
              echo ""
              echo "âœ… SUCESSO! Push realizado com sucesso!"
              SUCCESS=true
              break
            else
              echo "âŒ Push falhou na tentativa $ATTEMPT"
              
              # Se nÃ£o foi a Ãºltima tentativa, aguarda
              if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                # Backoff exponencial: 5s, 10s, 15s, 20s, 25s
                SLEEP_TIME=$((ATTEMPT * 5))
                echo "â³ Aguardando ${SLEEP_TIME}s antes de nova tentativa..."
                sleep $SLEEP_TIME
              fi
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          # Verifica resultado final
          if [ "$SUCCESS" = true ]; then
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âœ… COMMIT E PUSH FINALIZADOS COM SUCESSO"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          else
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âŒ FALHA APÃ“S $MAX_ATTEMPTS TENTATIVAS"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "ğŸ” PossÃ­veis causas:"
            echo "   â€¢ MÃºltiplos workflows rodando simultaneamente"
            echo "   â€¢ Problema de permissÃµes no repositÃ³rio"
            echo "   â€¢ Instabilidade da rede"
            echo "   â€¢ Branch protegida com regras restritivas"
            echo ""
            exit 1
          fi
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 6. TRIGGER BUILD NO NETLIFY
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸš€ Disparar Build no Netlify
        id: netlify
        run: |
          echo "ğŸš€ Disparando build no Netlify..."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Faz request para build hook
          RESPONSE=$(curl -X POST -d {} \
            -w "\n%{http_code}" \
            -s "${{ secrets.NETLIFY_BUILD_HOOK }}" \
            2>&1)
          
          # Extrai cÃ³digo HTTP e body
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)
          
          echo "ğŸ“¡ Response HTTP: $HTTP_CODE"
          
          # Valida resposta
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "âœ… Build disparado com sucesso!"
            echo ""
            echo "ğŸ“‹ Response body:"
            echo "$BODY"
            echo ""
            echo "ğŸŒ Acompanhe o deploy em:"
            echo "   https://app.netlify.com/sites/newmonalytics/deploys"
          else
            echo "âŒ Erro ao disparar build (HTTP $HTTP_CODE)"
            echo ""
            echo "ğŸ“‹ Response body:"
            echo "$BODY"
            echo ""
            echo "ğŸ” PossÃ­veis causas:"
            echo "   â€¢ URL do build hook incorreta"
            echo "   â€¢ Site pausado no Netlify"
            echo "   â€¢ Limite de builds excedido"
            echo "   â€¢ Problema de autenticaÃ§Ã£o"
            echo ""
            exit 1
          fi
          
          # Exporta URL para prÃ³ximos steps
          echo "netlify_url=https://app.netlify.com/sites/newmonalytics/deploys" >> $GITHUB_OUTPUT
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 7. RESUMO FINAL
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“Š Resumo do Deploy
        if: always()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "                  ğŸš€ DEPLOY NETLIFY                      "
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "â° HorÃ¡rio do Deploy:"
          echo "   $(TZ='America/Sao_Paulo' date '+%d/%m/%Y %H:%M:%S %Z')"
          echo ""
          echo "ğŸ”„ InformaÃ§Ãµes do Workflow:"
          echo "   â€¢ Trigger: ${{ github.event_name }}"
          echo "   â€¢ Run ID: ${{ github.run_id }}"
          echo "   â€¢ Run Number: ${{ github.run_number }}"
          echo "   â€¢ Commit SHA: ${{ github.sha }}"
          echo "   â€¢ Branch: ${{ github.ref_name }}"
          echo "   â€¢ Actor: ${{ github.actor }}"
          echo ""
          echo "ğŸ“¦ Status dos Steps:"
          echo "   â€¢ Checkout: âœ…"
          echo "   â€¢ ValidaÃ§Ã£o: âœ…"
          echo "   â€¢ Aguardar Workflows: âœ…"
          echo "   â€¢ Gerar Timestamp: ${{ steps.timestamp.outcome == 'success' && 'âœ…' || 'âŒ' }}"
          echo "   â€¢ Commit/Push: ${{ job.status == 'success' && 'âœ…' || 'âŒ' }}"
          echo "   â€¢ Trigger Netlify: ${{ steps.netlify.outcome == 'success' && 'âœ…' || 'âŒ' }}"
          echo ""
          echo "ğŸŒ Links Ãšteis:"
          echo "   â€¢ Deploy Netlify: https://app.netlify.com/sites/newmonalytics/deploys"
          echo "   â€¢ Site ProduÃ§Ã£o: https://newmonalytics.netlify.app"
          echo "   â€¢ RepositÃ³rio: https://github.com/${{ github.repository }}"
          echo "   â€¢ Este Workflow: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 8. NOTIFICAÃ‡ÃƒO DE FALHA
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸš¨ Notificar Falha (Se Houver)
        if: failure()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "                    âŒ DEPLOY FALHOU                     "
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âš ï¸  O deploy para o Netlify falhou!"
          echo ""
          echo "ğŸ” Verifique os seguintes pontos:"
          echo ""
          echo "   1. Secrets Configurados:"
          echo "      â€¢ NETLIFY_BUILD_HOOK estÃ¡ definido?"
          echo "      â€¢ URL do build hook estÃ¡ correta?"
          echo ""
          echo "   2. RepositÃ³rio:"
          echo "      â€¢ Branch main estÃ¡ protegida?"
          echo "      â€¢ HÃ¡ conflitos de merge?"
          echo "      â€¢ PermissÃµes do GITHUB_TOKEN estÃ£o OK?"
          echo ""
          echo "   3. Netlify:"
          echo "      â€¢ Site estÃ¡ ativo?"
          echo "      â€¢ NÃ£o atingiu limite de builds?"
          echo "      â€¢ Build hook estÃ¡ habilitado?"
          echo ""
          echo "   4. Rede:"
          echo "      â€¢ GitHub Actions estÃ¡ operacional?"
          echo "      â€¢ Netlify estÃ¡ operacional?"
          echo ""
          echo "ğŸ“‹ Para investigar:"
          echo "   â€¢ Veja os logs acima para identificar o step que falhou"
          echo "   â€¢ Acesse: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "ğŸ”§ AÃ§Ãµes sugeridas:"
          echo "   â€¢ Re-executar o workflow manualmente"
          echo "   â€¢ Verificar status do Netlify: https://status.netlify.com"
          echo "   â€¢ Verificar status do GitHub: https://www.githubstatus.com"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 9. LIMPEZA (OPCIONAL)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ§¹ Limpeza
        if: always()
        run: |
          # Remove backup se existir
          rm -f site/data/ultima_atualizacao.json.bak
          echo "âœ… Limpeza concluÃ­da"
