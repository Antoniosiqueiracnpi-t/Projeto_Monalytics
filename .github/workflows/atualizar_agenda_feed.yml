name: Atualizar Agenda Dividendos via Feed

on:
  schedule:
    - cron: '30 22 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  atualizar-agenda:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Verificar feed de notÃ­cias
        id: check-feed
        run: |
          if [ -f "balancos/feed_noticias.json" ]; then
            echo "âœ… Feed de notÃ­cias encontrado"
            echo "feed_exists=true" >> $GITHUB_ENV
            
            ULTIMA_ATUALIZACAO=$(jq -r '.meta.ultima_atualizacao' balancos/feed_noticias.json)
            echo "Ãšltima atualizaÃ§Ã£o do feed: $ULTIMA_ATUALIZACAO"
          else
            echo "âš ï¸  Feed de notÃ­cias nÃ£o encontrado"
            echo "feed_exists=false" >> $GITHUB_ENV
          fi
      
      - name: Atualizar agenda de dividendos
        if: env.feed_exists == 'true'
        run: |
          echo "ðŸ“Š Atualizando agenda de dividendos a partir do feed..."
          python src/atualizar_agenda_dividendos_feed.py
      
      - name: Verificar arquivo atualizado
        if: env.feed_exists == 'true'
        run: |
          if [ -f "agenda_dividendos_acoes_investidor10.json" ]; then
            echo "âœ… Agenda atualizada"
            
            TOTAL=$(jq 'length' agenda_dividendos_acoes_investidor10.json)
            FUTUROS=$(jq --arg hoje "$(date +%Y-%m-%d)" '[.[] | select(.data_pagamento >= $hoje)] | length' agenda_dividendos_acoes_investidor10.json)
            
            echo ""
            echo "ðŸ“Š EstatÃ­sticas da agenda:"
            echo "   Total de proventos: $TOTAL"
            echo "   Proventos futuros: $FUTUROS"
          else
            echo "âš ï¸  Agenda nÃ£o encontrada"
          fi

      - name: ðŸ“ Atualizar timestamp
        if: env.feed_exists == 'true'
        run: |
          mkdir -p site/data
          
          TIMESTAMP=$(date +%s)000
          DATA=$(TZ='America/Sao_Paulo' date +'%Y-%m-%d')
          HORA=$(TZ='America/Sao_Paulo' date +'%H:%M BRT')
          
          cat > site/data/ultima_atualizacao.json << EOF
          {
            "timestamp": ${TIMESTAMP},
            "data": "${DATA}",
            "hora": "${HORA}",
            "fonte": "agenda_feed",
            "versao": "1.0.0"
          }
          EOF
          
          echo "âœ… Timestamp atualizado: ${TIMESTAMP} (${DATA} ${HORA})"
      
      - name: Commit e Push
        if: env.feed_exists == 'true'
        run: |
          git config user.name "actions-user"
          git config user.email "actions-user@users.noreply.github.com"
          
          if git diff --quiet agenda_dividendos_acoes_investidor10.json; then
            echo "â„¹ï¸  Nenhuma mudanÃ§a na agenda"
            exit 0
          fi
          
          git add agenda_dividendos_acoes_investidor10.json
          git add site/data/ultima_atualizacao.json
          git commit -m "ðŸ“Š Atualizar agenda dividendos - $(date +'%Y-%m-%d %H:%M') [skip netlify]"
          git push
          
          echo "âœ… Agenda atualizada e commitada"
      
      - name: Resumo
        if: always()
        run: |
          echo "======================================================================"
          echo "                   RESUMO DA ATUALIZAÃ‡ÃƒO"
          echo "======================================================================"
          echo "Feed de notÃ­cias: ${feed_exists:-false}"
          echo "Arquivo agenda: $([ -f agenda_dividendos_acoes_investidor10.json ] && echo 'existe' || echo 'nÃ£o existe')"
          echo "======================================================================"
