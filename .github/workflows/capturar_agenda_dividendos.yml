name: Capturar Agenda Dividendos Completa

on:
  schedule:
    - cron: '0 10 * * *'
  workflow_dispatch:
    inputs:
      modo:
        description: 'Modo de captura'
        required: true
        default: 'quantidade'
        type: choice
        options:
          - quantidade
          - ticker
          - lista
          - completo
      quantidade:
        description: 'Quantidade de empresas (modo quantidade)'
        required: false
        default: '10'
      ticker:
        description: 'Ticker especÃ­fico (modo ticker)'
        required: false
        default: ''
      lista:
        description: 'Lista de tickers separados por vÃ­rgula (modo lista)'
        required: false
        default: ''
      dias:
        description: 'Janela deslizante em dias (para evitar duplicatas e capturar anÃºncios perdidos)'
        required: false
        default: '10'

jobs:
  capturar-agenda-dividendos:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Instalar dependÃªncias
        run: |
          pip install finbr pandas requests lxml beautifulsoup4 --break-system-packages

      - name: Capturar dividendos histÃ³ricos
        run: |
          echo "ğŸ“Š Capturando dividendos histÃ³ricos (finbr)..."

          if [ "${{ github.event_name }}" == "schedule" ]; then
            echo "ğŸ¤– ExecuÃ§Ã£o automÃ¡tica: modo completo"
            python src/capturar_dividendos_passados.py --modo completo
          else
            echo "ğŸ‘¤ ExecuÃ§Ã£o manual: modo ${{ github.event.inputs.modo }}"

            if [ "${{ github.event.inputs.modo }}" == "ticker" ]; then
              python src/capturar_dividendos_passados.py \
                --modo ticker \
                --ticker "${{ github.event.inputs.ticker }}"

            elif [ "${{ github.event.inputs.modo }}" == "lista" ]; then
              python src/capturar_dividendos_passados.py \
                --modo lista \
                --lista "${{ github.event.inputs.lista }}"

            elif [ "${{ github.event.inputs.modo }}" == "quantidade" ]; then
              python src/capturar_dividendos_passados.py \
                --modo quantidade \
                --quantidade "${{ github.event.inputs.quantidade }}"

            elif [ "${{ github.event.inputs.modo }}" == "completo" ]; then
              python src/capturar_dividendos_passados.py --modo completo
            fi
          fi

      - name: Capturar dividendos futuros (OFICIAL B3 LISTADOS + janela deslizante)
        run: |
          echo "ğŸ”® Capturando dividendos futuros (B3 Listados - oficial + janela)..."

          if [ "${{ github.event_name }}" == "schedule" ]; then
            echo "ğŸ¤– ExecuÃ§Ã£o automÃ¡tica: modo completo (janela=10 dias)"
            python src/capturar_dividendos_futuros.py --modo completo --dias 10
          else
            echo "ğŸ‘¤ ExecuÃ§Ã£o manual: modo ${{ github.event.inputs.modo }} (janela=${{ github.event.inputs.dias }} dias)"

            if [ "${{ github.event.inputs.modo }}" == "ticker" ]; then
              python src/capturar_dividendos_futuros.py \
                --modo ticker \
                --ticker "${{ github.event.inputs.ticker }}" \
                --dias "${{ github.event.inputs.dias }}"

            elif [ "${{ github.event.inputs.modo }}" == "lista" ]; then
              python src/capturar_dividendos_futuros.py \
                --modo lista \
                --lista "${{ github.event.inputs.lista }}" \
                --dias "${{ github.event.inputs.dias }}"

            elif [ "${{ github.event.inputs.modo }}" == "quantidade" ]; then
              python src/capturar_dividendos_futuros.py \
                --modo quantidade \
                --quantidade "${{ github.event.inputs.quantidade }}" \
                --dias "${{ github.event.inputs.dias }}"

            elif [ "${{ github.event.inputs.modo }}" == "completo" ]; then
              python src/capturar_dividendos_futuros.py --modo completo --dias "${{ github.event.inputs.dias }}"
            fi
          fi

      - name: Consolidar agenda de dividendos
        run: |
          echo "ğŸ“¦ Consolidando dividendos em agenda Ãºnica..."
          python src/consolidar_dividendos.py

      - name: Verificar arquivos gerados
        run: |
          echo "ğŸ” Verificando arquivos gerados..."

          if [ -f "balancos/agenda_dividendos.json" ]; then
            echo "âœ… agenda_dividendos.json criado"
            TAMANHO=$(du -h balancos/agenda_dividendos.json | cut -f1)
            echo "   Tamanho: $TAMANHO"
          else
            echo "âš ï¸  agenda_dividendos.json nÃ£o encontrado"
          fi

          if [ -f "balancos/agenda_dividendos_mes.json" ]; then
            echo "âœ… agenda_dividendos_mes.json criado"
          fi

          if [ -f "balancos/estatisticas_dividendos.json" ]; then
            echo "âœ… estatisticas_dividendos.json criado"
          fi

          HISTORICO_COUNT=$(find balancos -name "dividendos_historico.json" | wc -l)
          FUTUROS_COUNT=$(find balancos -name "dividendos_futuros.json" | wc -l)

          echo ""
          echo "ğŸ“Š Resumo:"
          echo "   Dividendos histÃ³ricos: $HISTORICO_COUNT empresas"
          echo "   Dividendos futuros: $FUTUROS_COUNT empresas"

      - name: ğŸ“ Atualizar timestamp
        run: |
          mkdir -p site/data

          TIMESTAMP=$(date +%s)000
          DATA=$(TZ='America/Sao_Paulo' date +'%Y-%m-%d')
          HORA=$(TZ='America/Sao_Paulo' date +'%H:%M BRT')

          cat > site/data/ultima_atualizacao.json << EOF
          {
            "timestamp": ${TIMESTAMP},
            "data": "${DATA}",
            "hora": "${HORA}",
            "fonte": "agenda_dividendos",
            "versao": "1.0.0"
          }
          EOF

          echo "âœ… Timestamp atualizado: ${TIMESTAMP} (${DATA} ${HORA})"

      - name: Commit e Push resultados
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add balancos/*/dividendos_historico.json 2>/dev/null || true
          git add balancos/*/dividendos_futuros.json 2>/dev/null || true
          git add balancos/dividendos_anunciados.json 2>/dev/null || true
          git add balancos/agenda_dividendos.json 2>/dev/null || true
          git add balancos/agenda_dividendos_mes.json 2>/dev/null || true
          git add balancos/estatisticas_dividendos.json 2>/dev/null || true
          git add site/data/ultima_atualizacao.json

          if git diff --staged --quiet; then
            echo "âš ï¸  Nenhuma mudanÃ§a para commit"
            exit 0
          fi

          if [ "${{ github.event_name }}" == "schedule" ]; then
            COMMIT_MSG="ğŸ’° Atualizar agenda completa de dividendos (automÃ¡tico - $(date +'%Y-%m-%d %H:%M')) [skip netlify]"
          else
            COMMIT_MSG="ğŸ’° Atualizar agenda completa de dividendos - ${{ github.event.inputs.modo }} (janela=${{ github.event.inputs.dias }}d) [skip netlify]"
          fi

          git commit -m "$COMMIT_MSG"
          git push

          echo "âœ… Arquivos commitados e enviados com sucesso!"
