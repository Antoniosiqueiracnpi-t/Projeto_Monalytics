name: Capturar Agenda Dividendos Completa

on:
  # Execu√ß√£o autom√°tica di√°ria √†s 10h UTC (7h BRT) - ap√≥s captura de not√≠cias
  schedule:
    - cron: '0 10 * * *'
  
  # Execu√ß√£o manual com par√¢metros
  workflow_dispatch:
    inputs:
      modo:
        description: 'Modo de captura'
        required: true
        default: 'quantidade'
        type: choice
        options:
          - quantidade
          - ticker
          - lista
          - completo
      
      quantidade:
        description: 'Quantidade de empresas (modo quantidade)'
        required: false
        default: '10'
      
      ticker:
        description: 'Ticker espec√≠fico (modo ticker)'
        required: false
        default: ''
      
      lista:
        description: 'Lista de tickers separados por v√≠rgula (modo lista)'
        required: false
        default: ''

jobs:
  capturar-agenda-dividendos:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Instalar depend√™ncias
        run: |
          pip install finbr pandas requests --break-system-packages
      
      - name: Capturar dividendos hist√≥ricos
        run: |
          echo "üìä Capturando dividendos hist√≥ricos (finbr)..."
          
          if [ "${{ github.event_name }}" == "schedule" ]; then
            # Execu√ß√£o autom√°tica: capturar todas as empresas
            echo "ü§ñ Execu√ß√£o autom√°tica: modo completo"
            python src/capturar_dividendos_passados.py --modo completo
          else
            # Execu√ß√£o manual: usar par√¢metros fornecidos
            echo "üë§ Execu√ß√£o manual: modo ${{ github.event.inputs.modo }}"
            
            if [ "${{ github.event.inputs.modo }}" == "ticker" ]; then
              python src/capturar_dividendos_passados.py \
                --modo ticker \
                --ticker "${{ github.event.inputs.ticker }}"
            
            elif [ "${{ github.event.inputs.modo }}" == "lista" ]; then
              python src/capturar_dividendos_passados.py \
                --modo lista \
                --lista "${{ github.event.inputs.lista }}"
            
            elif [ "${{ github.event.inputs.modo }}" == "quantidade" ]; then
              python src/capturar_dividendos_passados.py \
                --modo quantidade \
                --quantidade "${{ github.event.inputs.quantidade }}"
            
            elif [ "${{ github.event.inputs.modo }}" == "completo" ]; then
              python src/capturar_dividendos_passados.py --modo completo
            fi
          fi
      
      - name: Capturar dividendos futuros
        run: |
          echo "üîÆ Capturando dividendos futuros (not√≠cias + B3 API)..."
          
          if [ "${{ github.event_name }}" == "schedule" ]; then
            # Execu√ß√£o autom√°tica: capturar todas as empresas
            echo "ü§ñ Execu√ß√£o autom√°tica: modo completo"
            python src/capturar_dividendos_futuros.py --modo completo
          else
            # Execu√ß√£o manual: usar par√¢metros fornecidos
            echo "üë§ Execu√ß√£o manual: modo ${{ github.event.inputs.modo }}"
            
            if [ "${{ github.event.inputs.modo }}" == "ticker" ]; then
              python src/capturar_dividendos_futuros.py \
                --modo ticker \
                --ticker "${{ github.event.inputs.ticker }}"
            
            elif [ "${{ github.event.inputs.modo }}" == "lista" ]; then
              python src/capturar_dividendos_futuros.py \
                --modo lista \
                --lista "${{ github.event.inputs.lista }}"
            
            elif [ "${{ github.event.inputs.modo }}" == "quantidade" ]; then
              python src/capturar_dividendos_futuros.py \
                --modo quantidade \
                --quantidade "${{ github.event.inputs.quantidade }}"
            
            elif [ "${{ github.event.inputs.modo }}" == "completo" ]; then
              python src/capturar_dividendos_futuros.py --modo completo
            fi
          fi
      
      - name: Consolidar agenda de dividendos
        run: |
          echo "üì¶ Consolidando dividendos em agenda √∫nica..."
          python src/consolidar_dividendos.py
      
      - name: Verificar arquivos gerados
        run: |
          echo "üîç Verificando arquivos gerados..."
          
          # Verificar se os JSONs principais foram criados
          if [ -f "balancos/agenda_dividendos.json" ]; then
            echo "‚úÖ agenda_dividendos.json criado"
            TAMANHO=$(du -h balancos/agenda_dividendos.json | cut -f1)
            echo "   Tamanho: $TAMANHO"
          else
            echo "‚ö†Ô∏è  agenda_dividendos.json n√£o encontrado"
          fi
          
          if [ -f "balancos/agenda_dividendos_mes.json" ]; then
            echo "‚úÖ agenda_dividendos_mes.json criado"
          fi
          
          if [ -f "balancos/estatisticas_dividendos.json" ]; then
            echo "‚úÖ estatisticas_dividendos.json criado"
          fi
          
          # Contar arquivos individuais
          HISTORICO_COUNT=$(find balancos -name "dividendos_historico.json" | wc -l)
          FUTUROS_COUNT=$(find balancos -name "dividendos_futuros.json" | wc -l)
          
          echo ""
          echo "üìä Resumo:"
          echo "   Dividendos hist√≥ricos: $HISTORICO_COUNT empresas"
          echo "   Dividendos futuros: $FUTUROS_COUNT empresas"
      
      - name: Commit e Push resultados
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Adicionar todos os arquivos de dividendos
          git add balancos/*/dividendos_historico.json 2>/dev/null || true
          git add balancos/*/dividendos_futuros.json 2>/dev/null || true
          git add balancos/agenda_dividendos.json 2>/dev/null || true
          git add balancos/agenda_dividendos_mes.json 2>/dev/null || true
          git add balancos/estatisticas_dividendos.json 2>/dev/null || true
          
          # Verificar se h√° mudan√ßas
          if git diff --staged --quiet; then
            echo "‚ö†Ô∏è  Nenhuma mudan√ßa para commit"
            exit 0
          fi
          
          # Criar mensagem de commit
          if [ "${{ github.event_name }}" == "schedule" ]; then
            COMMIT_MSG="üí∞ Atualizar agenda completa de dividendos (autom√°tico - $(date +'%Y-%m-%d %H:%M')) [skip netlify]"
          else
            COMMIT_MSG="üí∞ Atualizar agenda completa de dividendos - ${{ github.event.inputs.modo }} [skip netlify]"
          fi
          
          # Commit e push
          git commit -m "$COMMIT_MSG"
          git push
          
          echo "‚úÖ Arquivos commitados e enviados com sucesso!"
          echo ""
          echo "üìÇ Arquivos dispon√≠veis:"
          echo "   - balancos/agenda_dividendos.json"
          echo "   - balancos/agenda_dividendos_mes.json"
          echo "   - balancos/estatisticas_dividendos.json"
