name: Atualizar Hist√≥rico de Pre√ßos

on:
  schedule:
    - cron: '0 23 * * *'  # 23h UTC (20h BRT) - ap√≥s fechamento do mercado
  workflow_dispatch:
    inputs:
      modo:
        description: 'Modo de execu√ß√£o'
        required: false
        default: 'todos'
        type: choice
        options:
          - todos
          - quantidade
          - lista
      quantidade:
        description: 'Quantidade de empresas (se modo=quantidade)'
        required: false
        default: '50'
      lista:
        description: 'Lista de tickers (se modo=lista, ex: PETR4,VALE3)'
        required: false
        default: ''

jobs:
  atualizar-historico:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout reposit√≥rio
        uses: actions/checkout@v4
      
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Instalar depend√™ncias
        run: |
          pip install -q yfinance pandas numpy openpyxl
      
      - name: Verificar arquivos necess√°rios
        run: |
          if [ ! -f "mapeamento_consolidado_tickers.xlsx" ]; then
            echo "‚ö†Ô∏è  mapeamento_consolidado_tickers.xlsx n√£o encontrado"
            exit 1
          fi
          echo "‚úÖ Arquivos OK"
      
      - name: Capturar hist√≥rico de pre√ßos
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Execu√ß√£o manual com par√¢metros
            MODO="${{ github.event.inputs.modo }}"
            QTD="${{ github.event.inputs.quantidade }}"
            LISTA="${{ github.event.inputs.lista }}"
            
            if [ "$MODO" = "lista" ] && [ -n "$LISTA" ]; then
              python src/capturar_historico_precos.py --modo lista --lista "$LISTA" --incluir-ibov
            elif [ "$MODO" = "quantidade" ]; then
              python src/capturar_historico_precos.py --modo quantidade --quantidade "$QTD" --incluir-ibov
            else
              python src/capturar_historico_precos.py --modo todos --incluir-ibov
            fi
          else
            # Execu√ß√£o autom√°tica: todas as empresas + IBOVESPA
            python src/capturar_historico_precos.py --modo todos --incluir-ibov
          fi
      
      - name: Estat√≠sticas de captura
        run: |
          echo "üìä Estat√≠sticas de Hist√≥rico de Pre√ßos"
          echo "======================================"
          
          # Contar arquivos criados
          TOTAL=$(find balancos -name "historico_precos.json" 2>/dev/null | wc -l)
          echo "Total de arquivos: $TOTAL"
          
          # Verificar IBOVESPA
          if [ -f "balancos/IBOV/historico_precos.json" ]; then
            echo "‚úÖ IBOVESPA capturado"
            
            # Mostrar √∫ltima cota√ß√£o do IBOV
            IBOV_ULTIMO=$(jq -r '.estatisticas.preco_atual // "N/A"' balancos/IBOV/historico_precos.json)
            IBOV_VAR=$(jq -r '.estatisticas.variacao_periodo // "N/A"' balancos/IBOV/historico_precos.json)
            echo "   √öltimo: $IBOV_ULTIMO | Varia√ß√£o 5Y: ${IBOV_VAR}%"
          fi
          
          # Exemplos de arquivos criados
          echo ""
          echo "Exemplos de arquivos:"
          find balancos -name "historico_precos.json" | head -5
          
          # Tamanho m√©dio dos arquivos
          if [ "$TOTAL" -gt 0 ]; then
            AVG_SIZE=$(find balancos -name "historico_precos.json" -exec ls -l {} \; | awk '{sum+=$5; count++} END {print int(sum/count/1024)}')
            echo ""
            echo "Tamanho m√©dio por arquivo: ${AVG_SIZE} KB"
          fi
      
      - name: Commit e Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions"
          
          # Verificar se h√° mudan√ßas
          if [ -n "$(git status --porcelain balancos/*/historico_precos.json)" ]; then
            git add balancos/*/historico_precos.json
            git commit -m "ü§ñ Atualizar hist√≥rico de pre√ßos - $(date +'%Y-%m-%d %H:%M')"
            git push
            echo "‚úÖ Hist√≥rico atualizado e commitado"
          else
            echo "‚ÑπÔ∏è  Nenhuma mudan√ßa detectada"
          fi
