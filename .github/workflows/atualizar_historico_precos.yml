name: Atualizar HistÃ³rico de PreÃ§os

on:
  schedule:
    - cron: '0 23 * * *'
  workflow_dispatch:
    inputs:
      modo:
        description: 'Modo de execuÃ§Ã£o'
        required: false
        default: 'todos'
        type: choice
        options:
          - todos
          - quantidade
          - lista
      quantidade:
        description: 'Quantidade de empresas (se modo=quantidade)'
        required: false
        default: '50'
      lista:
        description: 'Lista de tickers (se modo=lista, ex: PETR4,VALE3)'
        required: false
        default: ''

jobs:
  atualizar-historico:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repositÃ³rio
        uses: actions/checkout@v4
      
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Instalar dependÃªncias
        run: |
          pip install -q yfinance pandas numpy
      
      - name: Verificar arquivos necessÃ¡rios
        run: |
          if [ ! -f "mapeamento_b3_consolidado.csv" ]; then
            echo "âš ï¸  mapeamento_b3_consolidado.csv nÃ£o encontrado"
            exit 1
          fi
          echo "âœ… Arquivos OK"
      
      - name: Capturar histÃ³rico de preÃ§os
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            MODO="${{ github.event.inputs.modo }}"
            QTD="${{ github.event.inputs.quantidade }}"
            LISTA="${{ github.event.inputs.lista }}"
            
            if [ "$MODO" = "lista" ] && [ -n "$LISTA" ]; then
              python src/capturar_historico_precos.py --modo lista --lista "$LISTA" --incluir-ibov
            elif [ "$MODO" = "quantidade" ]; then
              python src/capturar_historico_precos.py --modo quantidade --quantidade "$QTD" --incluir-ibov
            else
              python src/capturar_historico_precos.py --modo todos --incluir-ibov
            fi
          else
            python src/capturar_historico_precos.py --modo todos --incluir-ibov
          fi
      
      - name: EstatÃ­sticas de captura
        run: |
          echo "ðŸ“Š EstatÃ­sticas de HistÃ³rico de PreÃ§os"
          echo "======================================"
          
          TOTAL=$(find balancos -name "historico_precos_diarios.json" 2>/dev/null | wc -l)
          echo "Total de arquivos: $TOTAL"
          
          if [ -f "balancos/IBOV/historico_precos_diarios.json" ]; then
            echo "âœ… IBOVESPA capturado"
            
            IBOV_ULTIMO=$(jq -r '.estatisticas.preco_atual // "N/A"' balancos/IBOV/historico_precos_diarios.json)
            IBOV_VAR=$(jq -r '.estatisticas.variacao_periodo // "N/A"' balancos/IBOV/historico_precos_diarios.json)
            echo "   Ãšltimo: $IBOV_ULTIMO | VariaÃ§Ã£o 5Y: ${IBOV_VAR}%"
          fi
          
          echo ""
          echo "Exemplos de arquivos:"
          find balancos -name "historico_precos_diarios.json" | head -5
          
          if [ "$TOTAL" -gt 0 ]; then
            AVG_SIZE=$(find balancos -name "historico_precos_diarios.json" -exec ls -l {} \; | awk '{sum+=$5; count++} END {print int(sum/count/1024)}')
            echo ""
            echo "Tamanho mÃ©dio por arquivo: ${AVG_SIZE} KB"
          fi

      - name: ðŸ“ Atualizar timestamp
        run: |
          mkdir -p site/data
          
          TIMESTAMP=$(date +%s)000
          DATA=$(TZ='America/Sao_Paulo' date +'%Y-%m-%d')
          HORA=$(TZ='America/Sao_Paulo' date +'%H:%M BRT')
          
          cat > site/data/ultima_atualizacao.json << EOF
          {
            "timestamp": ${TIMESTAMP},
            "data": "${DATA}",
            "hora": "${HORA}",
            "fonte": "historico_precos",
            "versao": "1.0.0"
          }
          EOF
          
          echo "âœ… Timestamp atualizado: ${TIMESTAMP} (${DATA} ${HORA})"
      
      - name: Commit e Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions"
          
          if [ -n "$(git status --porcelain balancos/*/historico_precos_diarios.json)" ]; then
            git add balancos/*/historico_precos_diarios.json
            git add site/data/ultima_atualizacao.json
            git commit -m "ðŸ¤– Atualizar histÃ³rico de preÃ§os - $(date +'%Y-%m-%d %H:%M') [skip netlify]"
            git push
            echo "âœ… HistÃ³rico atualizado e commitado"
          else
            echo "â„¹ï¸  Nenhuma mudanÃ§a detectada"
          fi
