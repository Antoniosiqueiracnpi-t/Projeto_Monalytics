name: üì∞ Atualizar Notici√°rio Empresarial (08:00 BRT)

on:
  workflow_dispatch:
    inputs:
      modo:
        description: "Modo de sele√ß√£o"
        required: true
        type: choice
        options:
          - quantidade
          - ticker
          - lista
          - faixa
        default: quantidade

      quantidade:
        description: "Quantidade (modo quantidade): 10, 50, 308=todas"
        required: false
        default: "308"

      ticker:
        description: "Ticker √∫nico (modo ticker): ex: PETR4"
        required: false
        default: ""

      lista:
        description: "Lista de tickers (modo lista): ex: PETR4,VALE3,ITUB4"
        required: false
        default: ""

      faixa:
        description: "Faixa (modo faixa): ex: 1-50, 51-150, 151-308"
        required: false
        default: "1-50"

  schedule:
    # GitHub cron em UTC. BRT (UTC-3): 08:00 => 11:00 UTC | Segunda a Sexta
    - cron: "0 11 * * 1-5"

permissions:
  contents: write

concurrency:
  group: noticiario-empresarial
  cancel-in-progress: true

jobs:
  atualizar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Commit e push (reset + regenerar)
        shell: bash
        run: |
          set -e

          git config user.name "GitHub Actions Bot"
          git config user.email "actions@users.noreply.github.com"
          git config pull.rebase false

          # Inputs (schedule n√£o tem inputs -> cai nos defaults abaixo)
          MODO="${{ github.event.inputs.modo }}"
          QTD="${{ github.event.inputs.quantidade }}"
          TICKER="${{ github.event.inputs.ticker }}"
          LISTA="${{ github.event.inputs.lista }}"
          FAIXA="${{ github.event.inputs.faixa }}"

          if [ -z "$MODO" ]; then MODO="quantidade"; fi
          if [ -z "$QTD" ]; then QTD="308"; fi
          if [ -z "$FAIXA" ]; then FAIXA="1-50"; fi

          # Valida√ß√£o simples
          if [ "$MODO" = "ticker" ] && [ -z "$TICKER" ]; then
            echo "‚ùå Modo=ticker exige input 'ticker'"
            exit 1
          fi

          if [ "$MODO" = "lista" ] && [ -z "$LISTA" ]; then
            echo "‚ùå Modo=lista exige input 'lista'"
            exit 1
          fi

          MAX_TENTATIVAS=8

          for i in $(seq 1 $MAX_TENTATIVAS); do
            echo ""
            echo "======================================="
            echo "Tentativa $i/$MAX_TENTATIVAS"
            echo "======================================="

            # Abortar opera√ß√µes pendentes
            git rebase --abort 2>/dev/null || true
            git merge --abort 2>/dev/null || true

            # Sincronizar com origin
            echo "Sincronizando com origin/main..."
            git fetch origin main
            git reset --hard origin/main

            # Rodar script
            echo "Rodando capturar_noticiario_empresarial.py (modo=$MODO)..."
            if [ "$MODO" = "ticker" ]; then
              python src/capturar_noticiario_empresarial.py --modo ticker --ticker "$TICKER"
            elif [ "$MODO" = "lista" ]; then
              python src/capturar_noticiario_empresarial.py --modo lista --lista "$LISTA"
            elif [ "$MODO" = "faixa" ]; then
              python src/capturar_noticiario_empresarial.py --modo faixa --faixa "$FAIXA"
            else
              python src/capturar_noticiario_empresarial.py --modo quantidade --quantidade "$QTD"
            fi

            # Adicionar arquivos
            git add balancos/*/noticiario.json 2>/dev/null || true

            # Verificar se h√° mudan√ßas
            if git diff --cached --quiet; then
              echo "Nada novo para commitar."
              exit 0
            fi

            # Commit
            TS=$(TZ="America/Sao_Paulo" date +"%Y-%m-%d %H:%M:%S %Z")
            git commit -m "üì∞ Notici√°rio empresarial: ${TS}"

            # Push
            if git push origin main; then
              echo "Push realizado com sucesso!"
              exit 0
            else
              echo "Push falhou. Tentando novamente em 10s..."
              sleep 10
            fi
          done

          echo "Falha ap√≥s $MAX_TENTATIVAS tentativas."
          exit 1
