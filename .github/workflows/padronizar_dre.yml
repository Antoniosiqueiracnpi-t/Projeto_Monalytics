name: Padronizar DRE

on:
  # Executar manualmente (botÃ£o no GitHub)
  workflow_dispatch:
    inputs:
      modo:
        description: 'Modo de execuÃ§Ã£o'
        required: true
        type: choice
        options:
          - 'todas'
          - 'ticker'
          - 'csv_quantidade'
        default: 'todas'
      
      ticker:
        description: 'Ticker especÃ­fico (modo ticker): ex: PETR4'
        required: false
        default: ''
      
      quantidade:
        description: 'Quantidade do CSV (modo csv_quantidade): ex: 10, 50'
        required: false
        default: '10'
      
      validar:
        description: 'Executar validaÃ§Ã£o?'
        required: true
        type: boolean
        default: true

  # Executar automaticamente apÃ³s captura de balanÃ§os
  workflow_run:
    workflows: ["Capturar BalanÃ§os"]
    types:
      - completed

jobs:
  padronizar:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ðŸ“¥ Baixar cÃ³digo
      uses: actions/checkout@v3
    
    - name: ðŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ðŸ“¦ Instalar bibliotecas
      run: pip install pandas numpy
    
    - name: ðŸ” Verificar arquivos disponÃ­veis
      run: |
        echo "ðŸ“‚ Estrutura de balancos/"
        ls -la balancos/ || echo "Pasta balancos/ nÃ£o encontrada"
        echo ""
        echo "ðŸ“‹ Empresas com DRE:"
        find balancos/ -name "dre_*.csv" 2>/dev/null | wc -l || echo "0"
    
    - name: ðŸš€ Executar padronizaÃ§Ã£o - Todas
      if: github.event.inputs.modo == 'todas' || github.event_name == 'workflow_run'
      run: python src/padronizar_dre.py
    
    - name: ðŸš€ Executar padronizaÃ§Ã£o - Ticker especÃ­fico
      if: github.event.inputs.modo == 'ticker' && github.event.inputs.ticker != ''
      run: python src/padronizar_dre.py "${{ github.event.inputs.ticker }}"
    
    - name: ðŸš€ Executar padronizaÃ§Ã£o - CSV com quantidade
      if: github.event.inputs.modo == 'csv_quantidade'
      run: python src/padronizar_dre.py csv "${{ github.event.inputs.quantidade }}"
    
    - name: ðŸ“Š RelatÃ³rio de padronizaÃ§Ã£o
      if: always()
      run: |
        echo ""
        echo "ðŸ“Š RELATÃ“RIO DE PADRONIZAÃ‡ÃƒO"
        echo "=============================="
        
        total_empresas=$(find balancos/ -type d -mindepth 1 -maxdepth 1 2>/dev/null | wc -l || echo "0")
        total_dre_padronizado=$(find balancos/ -name "dre_padronizado.csv" 2>/dev/null | wc -l || echo "0")
        
        echo "Total de empresas: $total_empresas"
        echo "DREs padronizados: $total_dre_padronizado"
        echo ""
        
        if [ $total_dre_padronizado -gt 0 ]; then
          echo "âœ… Empresas com DRE padronizado:"
          find balancos/ -name "dre_padronizado.csv" -exec dirname {} \; | xargs -n1 basename | head -10
          
          if [ $total_dre_padronizado -gt 10 ]; then
            echo "... e mais $((total_dre_padronizado - 10)) empresas"
          fi
        fi
    
    - name: ðŸ’¾ Salvar no GitHub
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add balancos/*/dre_padronizado.csv
        git diff --quiet && git diff --staged --quiet || git commit -m "DRE padronizado - $(date +'%Y-%m-%d %H:%M')"
        git push
