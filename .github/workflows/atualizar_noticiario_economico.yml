name: Atualizar NoticiÃ¡rio EconÃ´mico

on:
  schedule:
    # 08:00â€“20:00 BRT  => 11:00â€“23:00 UTC
    - cron: "0 11-23 * * *"
  workflow_dispatch:

concurrency:
  group: noticias-mercado
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  noticias:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 1

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ðŸ“¦ Instalar dependÃªncias
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: ðŸ“° Gerar + Commit + Push (sem conflito)
        shell: bash
        run: |
          set -e

          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

          MAX_RETRIES=6
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ðŸ” Tentativa $((RETRY_COUNT+1))/$MAX_RETRIES"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

            echo "ðŸ”„ Sincronizando com origin/main (sem rebase, sem merge)..."
            git fetch origin main
            git reset --hard origin/main

            echo "ðŸ“° Rodando capturar_noticiario_economico.py..."
            python src/capturar_noticiario_economico.py

            echo "ðŸ“ Atualizando timestamp (diagnÃ³stico/telemetria)..."
            mkdir -p site/data
            TIMESTAMP=$(date +%s)000
            DATA=$(TZ='America/Sao_Paulo' date +'%Y-%m-%d')
            HORA=$(TZ='America/Sao_Paulo' date +'%H:%M BRT')

            cat > site/data/ultima_atualizacao.json << EOF
          {
            "timestamp": ${TIMESTAMP},
            "data": "${DATA}",
            "hora": "${HORA}",
            "fonte": "noticias_mercado",
            "versao": "1.0.0"
          }
          EOF

            echo "ðŸ” Verificando mudanÃ§as..."
            git add balancos/NOTICIAS/noticias_mercado.json site/data/ultima_atualizacao.json

            if git diff --staged --quiet; then
              echo "â„¹ï¸  Sem mudanÃ§as para commitar. Encerrando."
              exit 0
            fi

            TS_COMMIT=$(TZ='America/Sao_Paulo' date '+%Y-%m-%d %H:%M:%S %Z')
            git commit -m "ðŸ“° NotÃ­cias: ${TS_COMMIT} [skip netlify]"

            echo "ðŸš€ Tentando push..."
            if git push origin main; then
              echo "âœ… Push OK!"
              exit 0
            fi

            echo "âš ï¸ Push falhou (branch avanÃ§ou). Vou tentar novamente..."
            RETRY_COUNT=$((RETRY_COUNT + 1))
            sleep $((RETRY_COUNT * 8))
          done

          echo "âŒ Falha apÃ³s ${MAX_RETRIES} tentativas"
          exit 1

      - name: ðŸš¨ Notificar falha
        if: failure()
        run: |
          echo "âŒ Workflow falhou!"
