name: Pipeline por Setor ou Tickers (Sele√ß√£o de Etapas)

on:
  workflow_dispatch:
    inputs:
      # ========================================================================
      # MODO DE SELE√á√ÉO: SETOR OU TICKERS ESPEC√çFICOS
      # ========================================================================
      modo_selecao:
        description: "Como deseja selecionar as empresas?"
        required: true
        type: choice
        default: "setor"
        options:
          - "setor"
          - "tickers"

      # ========================================================================
      # OP√á√ÉO 1: SELE√á√ÉO POR SETOR
      # ========================================================================
      setor:
        description: "[SETOR] Selecione o setor (usado apenas se modo_selecao = 'setor')"
        required: false
        type: choice
        default: "TODOS"
        options:
          - "TODOS"
          - "Agropecu√°ria"
          - "Alimentos Processados"
          - "Autom√≥veis e Motocicletas"
          - "Bebidas"
          - "Computadores e Equipamentos"
          - "Com√©rcio Varejista"
          - "Com√©rcio e Distribui√ß√£o"
          - "Constru√ß√£o Civil"
          - "Constru√ß√£o e Engenharia"
          - "Corretoras de Seguros e Resseguros"
          - "Diversos"
          - "Embalagens"
          - "Energia El√©trica"
          - "Equipamentos"
          - "Explora√ß√£o de Im√≥veis"
          - "G√°s"
          - "Holdings Diversificadas"
          - "Hoteis e Restaurantes"
          - "Intermedi√°rios Financeiros"
          - "Madeira e Papel"
          - "Materiais Diversos"
          - "Material de Transporte"
          - "Medicamentos e Outros Produtos"
          - "Minera√ß√£o"
          - "M√°quinas e Equipamentos"
          - "Outros"
          - "Petr√≥leo"
          - "Previd√™ncia e Seguros"
          - "Produtos de Cuidado Pessoal e de Limpeza"
          - "Programas e Servi√ßos"
          - "Qu√≠micos"
          - "Serv.M√©d.Hospitalar"
          - "Servi√ßos"
          - "Siderurgia e Metalurgia"
          - "Tecidos"
          - "Telecomunica√ß√µes"
          - "Transporte"
          - "Utilidades Dom√©sticas"
          - "Viagens e Lazer"
          - "√Ågua e Saneamento"

      limite:
        description: "[SETOR] Limite de tickers (0 = todos). Usado apenas se modo_selecao = 'setor'"
        required: false
        default: "0"
        type: string

      # ========================================================================
      # OP√á√ÉO 2: SELE√á√ÉO POR TICKERS ESPEC√çFICOS
      # ========================================================================
      tickers_manuais:
        description: "[TICKERS] Lista de tickers separados por v√≠rgula (ex: PETR4,VALE3,ABEV3). Usado apenas se modo_selecao = 'tickers'"
        required: false
        type: string
        default: ""

      # ========================================================================
      # SELE√á√ÉO DE ETAPAS A EXECUTAR
      # ========================================================================
      etapas:
        description: "Quais etapas executar? (separe por v√≠rgula ou digite 'todas')"
        required: true
        type: string
        default: "todas"
        # Op√ß√µes dispon√≠veis (exemplos para o usu√°rio):
        # todas
        # balancos,dividendos,acoes
        # dre,dfc,bp
        # precos_historico,atualizar_precos
        # multiplos,analise
        # balancos,dre,multiplos (somente essenciais)

permissions:
  contents: write

concurrency:
  group: pipeline-setor
  cancel-in-progress: false

jobs:
  pipeline:
    runs-on: ubuntu-latest
    env:
      PYTHONUTF8: "1"

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ========================================================================
      # SELE√á√ÉO DE TICKERS (POR SETOR OU LISTA MANUAL)
      # ========================================================================
      
      - name: Selecionar tickers (setor ou manual)
        id: selecionar
        env:
          MODO_SELECAO: ${{ inputs.modo_selecao }}
          SETOR: ${{ inputs.setor }}
          LIMITE: ${{ inputs.limite }}
          TICKERS_MANUAIS: ${{ inputs.tickers_manuais }}
        run: |
          python - <<'PY'
          from pathlib import Path
          import os, sys
          import pandas as pd

          modo = (os.environ.get("MODO_SELECAO") or "setor").strip().lower()
          
          # ============================================================
          # MODO 1: TICKERS MANUAIS
          # ============================================================
          if modo == "tickers":
              tickers_str = (os.environ.get("TICKERS_MANUAIS") or "").strip()
              
              if not tickers_str:
                  print("‚ùå Modo 'tickers' selecionado, mas nenhum ticker foi fornecido.")
                  print("   Por favor, preencha o campo 'tickers_manuais' (ex: PETR4,VALE3,ABEV3)")
                  sys.exit(1)
              
              # Processar lista manual
              tickers = [t.strip().upper() for t in tickers_str.split(",") if t.strip()]
              
              if not tickers:
                  print("‚ùå Nenhum ticker v√°lido encontrado na lista fornecida.")
                  sys.exit(1)
              
              print(f"‚úÖ Modo: TICKERS MANUAIS | Quantidade: {len(tickers)}")
              print(f"   Tickers: {', '.join(tickers)}")
          
          # ============================================================
          # MODO 2: SELE√á√ÉO POR SETOR
          # ============================================================
          else:
              setor = (os.environ.get("SETOR") or "").strip()
              limite = int((os.environ.get("LIMITE") or "0").strip() or "0")

              # Localizar CSV
              candidates = [
                  Path("mapeamento_b3_consolidado.csv"),
                  Path("src/mapeamento_b3_consolidado.csv"),
              ]
              path = next((p for p in candidates if p.exists()), None)

              if path is None:
                  found = None
                  for p in Path(".").rglob("mapeamento_b3_consolidado.csv"):
                      found = p
                      break
                  path = found

              if path is None or not path.exists():
                  print("‚ùå mapeamento_b3_consolidado.csv n√£o encontrado no repo.")
                  sys.exit(1)

              df = pd.read_csv(path, sep=";", encoding="utf-8-sig")

              if "ticker" not in df.columns or "setor" not in df.columns:
                  print("‚ùå CSV inv√°lido: precisa ter colunas 'ticker' e 'setor'.")
                  print("Colunas encontradas:", list(df.columns))
                  sys.exit(1)

              # Filtrar por setor
              if setor.upper() == "TODOS":
                  df_sel = df
              else:
                  alvo = setor.casefold()
                  key = df["setor"].fillna("").astype(str).str.strip().str.casefold()
                  df_sel = df[key == alvo]

                  if df_sel.empty:
                      df_sel = df[key.str.contains(alvo, na=False)]

                  if df_sel.empty:
                      print(f"‚ùå Setor '{setor}' n√£o encontrado.")
                      print("\nSetores dispon√≠veis (no CSV):")
                      for s in sorted(df["setor"].dropna().astype(str).unique()):
                          print("-", s)
                      sys.exit(1)

              tickers = sorted({str(t).strip().upper() for t in df_sel["ticker"].dropna().tolist() if str(t).strip()})

              # Aplicar limite se fornecido
              if limite > 0:
                  tickers = tickers[:limite]

              if not tickers:
                  print(f"‚ùå Nenhum ticker encontrado para o setor '{setor}'.")
                  sys.exit(1)

              print(f"‚úÖ Modo: SETOR | Setor: {setor} | Tickers: {len(tickers)} | Limite: {limite or 'sem limite'} | CSV: {path}")

          # ============================================================
          # SALVAR TICKERS NO GITHUB_ENV
          # ============================================================
          tickers_csv = ",".join(tickers)
          
          env_file = os.environ["GITHUB_ENV"]
          with open(env_file, "a", encoding="utf-8") as f:
              f.write(f"TICKERS={tickers_csv}\n")
              f.write(f"TICKERS_COUNT={len(tickers)}\n")
              f.write(f"MODO_EXECUCAO={modo.upper()}\n")
          
          print(f"\n‚úÖ Total de tickers selecionados: {len(tickers)}")
          print(f"   Lista completa: {tickers_csv}")
          PY

      # ========================================================================
      # PROCESSAR ETAPAS SELECIONADAS
      # ========================================================================
      
      - name: Processar etapas selecionadas
        id: processar_etapas
        env:
          ETAPAS_INPUT: ${{ inputs.etapas }}
        run: |
          python - <<'PY'
          import os
          
          etapas_str = (os.environ.get("ETAPAS_INPUT") or "todas").strip().lower()
          
          # Lista completa de etapas dispon√≠veis
          todas_etapas = [
              "balancos", "dividendos", "acoes", "acionistas", "logos",
              "noticias", "noticiario", "historico_precos",
              "dre", "dfc", "bp",
              "precos_historico", "atualizar_precos",
              "multiplos", "analise"
          ]
          
          if etapas_str == "todas":
              etapas_executar = todas_etapas
          else:
              # Processar lista separada por v√≠rgulas
              etapas_executar = [e.strip() for e in etapas_str.split(",") if e.strip()]
              
              # Validar etapas
              invalidas = [e for e in etapas_executar if e not in todas_etapas]
              if invalidas:
                  print(f"‚ö†Ô∏è  AVISO: Etapas inv√°lidas ignoradas: {', '.join(invalidas)}")
                  etapas_executar = [e for e in etapas_executar if e in todas_etapas]
          
          if not etapas_executar:
              print("‚ùå Nenhuma etapa v√°lida selecionada.")
              print(f"   Etapas dispon√≠veis: {', '.join(todas_etapas)}")
              exit(1)
          
          print(f"‚úÖ Etapas selecionadas: {len(etapas_executar)}/{len(todas_etapas)}")
          print(f"   Lista: {', '.join(etapas_executar)}")
          
          # Salvar flags no GITHUB_ENV
          env_file = os.environ["GITHUB_ENV"]
          with open(env_file, "a", encoding="utf-8") as f:
              for etapa in todas_etapas:
                  flag = "true" if etapa in etapas_executar else "false"
                  f.write(f"EXEC_{etapa.upper()}={flag}\n")
          PY

      # ========================================================================
      # CAPTURAS (COM CONDICIONAIS)
      # ========================================================================
      
      - name: Capturar Balan√ßos
        id: balancos
        if: env.EXEC_BALANCOS == 'true'
        continue-on-error: true
        run: |
          python src/capturar_balancos.py --modo lista --lista "${TICKERS}"

      - name: Capturar Dividendos Trimestrais
        id: dividendos
        if: env.EXEC_DIVIDENDOS == 'true'
        continue-on-error: true
        run: |
          python src/capturar_dividendos.py --modo lista --lista "${TICKERS}"

      - name: Capturar Hist√≥rico de A√ß√µes
        id: acoes
        if: env.EXEC_ACOES == 'true'
        continue-on-error: true
        run: |
          python src/capturar_acoes.py --modo lista --lista "${TICKERS}"

      - name: Capturar Acionistas 
        id: acionistas
        if: env.EXEC_ACIONISTAS == 'true'
        continue-on-error: true
        run: |
          python src/capturar_acionistas.py --modo lista --lista "${TICKERS}"

      - name: Capturar Logos
        id: logos
        if: env.EXEC_LOGOS == 'true'
        continue-on-error: true
        run: |
          python src/capturar_logos.py --modo lista --lista "${TICKERS}"

      - name: Capturar Comunicados B3 (30 dias retroativos)
        id: comunicados
        if: env.EXEC_NOTICIAS == 'true'
        continue-on-error: true
        run: |
          python src/capturar_comunicados_b3.py --modo lista --lista "${TICKERS}" --dias 30

      - name: Capturar Noticiario Empresarial 
        id: noticiario
        if: env.EXEC_NOTICIARIO == 'true'
        continue-on-error: true
        run: |
          python src/capturar_noticiario_empresarial.py --modo lista --lista "${TICKERS}"

      - name: Capturar hist√≥rico de pre√ßos (5 anos)
        id: historico_precos
        if: env.EXEC_HISTORICO_PRECOS == 'true'
        continue-on-error: true
        run: |
          python src/capturar_historico_precos.py --modo lista --lista "${TICKERS}" --incluir-ibov

      # ========================================================================
      # PADRONIZA√á√ïES (COM CONDICIONAIS)
      # ========================================================================
      
      - name: Padronizar DRE
        id: dre
        if: env.EXEC_DRE == 'true'
        continue-on-error: true
        run: |
          python src/padronizar_dre.py --modo lista --lista "${TICKERS}"

      - name: Padronizar DFC
        id: dfc
        if: env.EXEC_DFC == 'true'
        continue-on-error: true
        run: |
          python src/padronizar_dfc.py --modo lista --lista "${TICKERS}"

      - name: Padronizar BP (BPA + BPP)
        id: bp
        if: env.EXEC_BP == 'true'
        continue-on-error: true
        run: |
          python src/padronizar_bp.py --modo lista --lista "${TICKERS}"

      # ========================================================================
      # PRE√áOS (COM CONDICIONAIS)
      # ========================================================================
      
      - name: Capturar Pre√ßos Trimestrais (Hist√≥rico Completo)
        id: precos_historico
        if: env.EXEC_PRECOS_HISTORICO == 'true'
        continue-on-error: true
        run: |
          python src/capturar_precos.py --modo lista --lista "${TICKERS}"

      - name: Atualizar Pre√ßos Di√°rios e Sincronizar A√ß√µes
        id: atualizar_precos
        if: env.EXEC_ATUALIZAR_PRECOS == 'true'
        continue-on-error: true
        run: |
          echo "=========================================="
          echo "ATUALIZA√á√ÉO DE PRE√áOS DI√ÅRIOS"
          echo "=========================================="
          echo "Esta etapa:"
          echo "1. Baixa pre√ßo atual do Yahoo Finance"
          echo "2. Atualiza precos_trimestrais.csv"
          echo "3. Sincroniza acoes_historico.csv (copia √∫ltimo per√≠odo)"
          echo "4. Garante que m√∫ltiplos de valuation ser√£o calculados"
          echo ""
          python src/atualizar_precos_diarios.py --modo lista --lista "${TICKERS}"

      # ========================================================================
      # M√öLTIPLOS E AN√ÅLISES (COM CONDICIONAIS)
      # ========================================================================
      
      - name: Calcular M√∫ltiplos
        id: multiplos
        if: env.EXEC_MULTIPLOS == 'true'
        continue-on-error: true
        run: |
          python src/calcular_multiplos.py --modo lista --lista "${TICKERS}"

      - name: Analisar Balan√ßos
        id: analise
        if: env.EXEC_ANALISE == 'true'
        continue-on-error: true
        run: |
          python src/analisar_balancos.py --modo lista --lista "${TICKERS}"

      # ========================================================================
      # RESUMO DE EXECU√á√ÉO
      # ========================================================================
      
      - name: Resumo de execu√ß√£o
        if: always()
        run: |
          echo "======================================================================"
          echo "                    RESUMO DO PIPELINE"
          echo "======================================================================"
          echo "Modo de sele√ß√£o:   ${MODO_EXECUCAO}"
          
          if [ "${MODO_EXECUCAO}" = "SETOR" ]; then
            echo "Setor selecionado: ${{ inputs.setor }}"
            echo "Limite aplicado:   ${{ inputs.limite }} (0 = todos)"
          else
            echo "Tickers fornecidos: ${{ inputs.tickers_manuais }}"
          fi
          
          echo "Total de tickers:  ${TICKERS_COUNT}"
          echo "Etapas solicitadas: ${{ inputs.etapas }}"
          echo "======================================================================"
          echo ""
          echo "Status por etapa (‚úÖ success | ‚ùå failure | ‚è≠Ô∏è skipped):"
          echo ""
          echo "üìä CAPTURAS:"
          echo "  - Balan√ßos:              ${{ steps.balancos.outcome || '‚è≠Ô∏è n√£o executada' }}"
          echo "  - Dividendos:            ${{ steps.dividendos.outcome || '‚è≠Ô∏è n√£o executada' }}"
          echo "  - A√ß√µes:                 ${{ steps.acoes.outcome || '‚è≠Ô∏è n√£o executada' }}"
          echo "  - Acionistas:            ${{ steps.acionistas.outcome || '‚è≠Ô∏è n√£o executada' }}"
          echo "  - Logos:                 ${{ steps.logos.outcome || '‚è≠Ô∏è n√£o executada' }}"
          echo "  - Not√≠cias:              ${{ steps.noticias.outcome || '‚è≠Ô∏è n√£o executada' }}"
          echo "  - Notici√°rio (Google):   ${{ steps.noticiario.outcome || '‚è≠Ô∏è n√£o executada' }}"
          echo "  - Hist√≥rico Pre√ßos:      ${{ steps.historico_precos.outcome || '‚è≠Ô∏è n√£o executada' }}"
          echo ""
          echo "üîÑ PADRONIZA√á√ïES:"
          echo "  - DRE:                   ${{ steps.dre.outcome || '‚è≠Ô∏è n√£o executada' }}"
          echo "  - DFC:                   ${{ steps.dfc.outcome || '‚è≠Ô∏è n√£o executada' }}"
          echo "  - BP (BPA + BPP):        ${{ steps.bp.outcome || '‚è≠Ô∏è n√£o executada' }}"
          echo ""
          echo "üí∞ PRE√áOS:"
          echo "  - Hist√≥rico Completo:    ${{ steps.precos_historico.outcome || '‚è≠Ô∏è n√£o executada' }}"
          echo "  - Atualiza√ß√£o Di√°ria:    ${{ steps.atualizar_precos.outcome || '‚è≠Ô∏è n√£o executada' }}"
          echo ""
          echo "üìà M√öLTIPLOS E AN√ÅLISES:"
          echo "  - C√°lculo M√∫ltiplos:     ${{ steps.multiplos.outcome || '‚è≠Ô∏è n√£o executada' }}"
          echo "  - An√°lise Balan√ßos:      ${{ steps.analise.outcome || '‚è≠Ô∏è n√£o executada' }}"
          echo ""
          echo "======================================================================"
          
          # Verificar se alguma etapa cr√≠tica falhou
          critical_failed=0
          
          if [ "${{ steps.balancos.outcome }}" = "failure" ]; then
            echo "‚ö†Ô∏è  ATEN√á√ÉO: Captura de balan√ßos falhou (etapa cr√≠tica)"
            critical_failed=1
          fi
          
          if [ "${{ steps.dre.outcome }}" = "failure" ]; then
            echo "‚ö†Ô∏è  ATEN√á√ÉO: Padroniza√ß√£o DRE falhou (etapa cr√≠tica)"
            critical_failed=1
          fi
          
          if [ "${{ steps.multiplos.outcome }}" = "failure" ]; then
            echo "‚ö†Ô∏è  ATEN√á√ÉO: C√°lculo de m√∫ltiplos falhou (etapa cr√≠tica)"
            critical_failed=1
          fi
          
          if [ $critical_failed -eq 0 ]; then
            echo "‚úÖ Pipeline executado com sucesso!"
          else
            echo "‚ö†Ô∏è  Pipeline conclu√≠do com avisos (verifique etapas cr√≠ticas acima)"
          fi
          echo "======================================================================"

      # ========================================================================
      # COMMIT E PUSH
      # ========================================================================
      
      - name: Commit e push dos resultados
        if: always()
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: |
            Pipeline (${{ env.MODO_EXECUCAO }}): ${{ inputs.modo_selecao == 'setor' && inputs.setor || 'Manual' }} | Tickers: ${{ env.TICKERS_COUNT }}${{ inputs.limite != '0' && inputs.modo_selecao == 'setor' && format(' | Limite: {0}', inputs.limite) || '' }} | Etapas: ${{ inputs.etapas }}
          
          file_pattern: |
            balancos/
            site/data/
            src/__pycache__/
          
          commit_user_name: actions-user
          commit_user_email: actions-user@users.noreply.github.com
          
          pull: '--rebase --autostash'
          push_options: '--force-with-lease'
          
          skip_dirty_check: false
          skip_fetch: false
          skip_checkout: false
