name: Pipeline por Setor (Capturas ‚Üí Padroniza√ß√µes ‚Üí Pre√ßos ‚Üí M√∫ltiplos)

on:
  workflow_dispatch:
    inputs:
      setor:
        description: "Selecione o setor (coluna 'setor' do mapeamento_b3_consolidado.csv)."
        required: true
        type: choice
        default: "TODOS"
        options:
          - "TODOS"
          - "Agropecu√°ria"
          - "Alimentos Processados"
          - "Autom√≥veis e Motocicletas"
          - "Bebidas"
          - "Computadores e Equipamentos"
          - "Com√©rcio Varejista"
          - "Com√©rcio e Distribui√ß√£o"
          - "Constru√ß√£o Civil"
          - "Constru√ß√£o e Engenharia"
          - "Diversos"
          - "Embalagens"
          - "Energia El√©trica"
          - "Equipamentos"
          - "Explora√ß√£o de Im√≥veis"
          - "G√°s"
          - "Holdings Diversificadas"
          - "Hoteis e Restaurantes"
          - "Intermedi√°rios Financeiros"
          - "Madeira e Papel"
          - "Materiais Diversos"
          - "Material de Transporte"
          - "Medicamentos e Outros Produtos"
          - "Minera√ß√£o"
          - "M√°quinas e Equipamentos"
          - "Outros"
          - "Petr√≥leo, G√°s e Biocombust√≠veis"
          - "Previd√™ncia e Seguros"
          - "Produtos de Cuidado Pessoal e de Limpeza"
          - "Programas e Servi√ßos"
          - "Qu√≠micos"
          - "Serv.M√©d.Hospit.,An√°lises e Diagn√≥sticos"
          - "Servi√ßos"
          - "Siderurgia e Metalurgia"
          - "Tecidos, Vestu√°rio e Cal√ßados"
          - "Telecomunica√ß√µes"
          - "Transporte"
          - "Utilidades Dom√©sticas"
          - "Viagens e Lazer"
          - "√Ågua e Saneamento"

      limite:
        description: "Opcional: limita a quantidade de tickers do setor (0 = todos). √ötil para testes r√°pidos."
        required: true
        default: "0"
        type: string

permissions:
  contents: write

jobs:
  pipeline:
    runs-on: ubuntu-latest
    env:
      PYTHONUTF8: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy requests yfinance openpyxl pillow

      - name: Selecionar tickers por setor (mapeamento_b3_consolidado.csv)
        id: selecionar
        env:
          SETOR: ${{ inputs.setor }}
          LIMITE: ${{ inputs.limite }}
        run: |
          python - <<'PY'
          from pathlib import Path
          import os, sys
          import pandas as pd

          setor = (os.environ.get("SETOR") or "").strip()
          limite = int((os.environ.get("LIMITE") or "0").strip() or "0")

          candidates = [
              Path("mapeamento_b3_consolidado.csv"),
              Path("src/mapeamento_b3_consolidado.csv"),
          ]
          path = next((p for p in candidates if p.exists()), None)

          if path is None:
              found = None
              for p in Path(".").rglob("mapeamento_b3_consolidado.csv"):
                  found = p
                  break
              path = found

          if path is None or not path.exists():
              print("‚ùå mapeamento_b3_consolidado.csv n√£o encontrado no repo.")
              sys.exit(1)

          df = pd.read_csv(path, sep=";", encoding="utf-8-sig")

          if "ticker" not in df.columns or "setor" not in df.columns:
              print("‚ùå CSV inv√°lido: precisa ter colunas 'ticker' e 'setor'.")
              print("Colunas encontradas:", list(df.columns))
              sys.exit(1)

          if setor.upper() == "TODOS":
              df_sel = df
          else:
              alvo = setor.casefold()
              key = df["setor"].fillna("").astype(str).str.strip().str.casefold()
              df_sel = df[key == alvo]

              if df_sel.empty:
                  df_sel = df[key.str.contains(alvo, na=False)]

              if df_sel.empty:
                  print(f"‚ùå Setor '{setor}' n√£o encontrado.")
                  print("\nSetores dispon√≠veis (no CSV):")
                  for s in sorted(df["setor"].dropna().astype(str).unique()):
                      print("-", s)
                  sys.exit(1)

          tickers = sorted({str(t).strip().upper() for t in df_sel["ticker"].dropna().tolist() if str(t).strip()})

          if limite > 0:
              tickers = tickers[:limite]

          if not tickers:
              print(f"‚ùå Nenhum ticker encontrado para o setor '{setor}'.")
              sys.exit(1)

          print(f"‚úÖ Setor: {setor} | Tickers: {len(tickers)} | CSV: {path}")
          tickers_csv = ",".join(tickers)

          env_file = os.environ["GITHUB_ENV"]
          with open(env_file, "a", encoding="utf-8") as f:
              f.write(f"TICKERS={tickers_csv}\n")
              f.write(f"TICKERS_COUNT={len(tickers)}\n")
          PY

      # ========================================================================
      # CAPTURAS (SEM PRE√áOS)
      # ========================================================================
      
      - name: Capturar Balan√ßos
        id: balancos
        continue-on-error: true
        run: |
          python src/capturar_balancos.py --modo lista --lista "${TICKERS}"

      - name: Capturar Dividendos Trimestrais
        id: dividendos
        continue-on-error: true
        run: |
          python src/capturar_dividendos.py --modo lista --lista "${TICKERS}"

      - name: Capturar Hist√≥rico de A√ß√µes
        id: acoes
        continue-on-error: true
        run: |
          python src/capturar_acoes.py --modo lista --lista "${TICKERS}"

      - name: Capturar Acionistas (Top 10)
        id: acionistas
        continue-on-error: true
        run: |
          python src/capturar_acionistas.py --modo lista --lista "${TICKERS}"

      - name: Capturar Logos
        id: logos
        continue-on-error: true
        run: |
          python src/capturar_logos.py --modo lista --lista "${TICKERS}"

      # ========================================================================
      # PADRONIZA√á√ïES
      # ========================================================================
      
      - name: Padronizar DRE
        id: dre
        continue-on-error: true
        run: |
          python src/padronizar_dre.py --modo lista --lista "${TICKERS}"

      - name: Padronizar DFC
        id: dfc
        continue-on-error: true
        run: |
          python src/padronizar_dfc.py --modo lista --lista "${TICKERS}"

      - name: Padronizar BP (BPA + BPP)
        id: bp
        continue-on-error: true
        run: |
          python src/padronizar_bp.py --modo lista --lista "${TICKERS}"

      # ========================================================================
      # PRE√áOS - ETAPA 1: CAPTURA HIST√ìRICA COMPLETA
      # ========================================================================
      
      - name: Capturar Pre√ßos Trimestrais (Hist√≥rico Completo)
        id: precos_historico
        continue-on-error: true
        run: |
          python src/capturar_precos.py --modo lista --lista "${TICKERS}"

      # ========================================================================
      # PRE√áOS - ETAPA 2: ATUALIZA√á√ÉO DI√ÅRIA E SINCRONIZA√á√ÉO
      # ========================================================================
      
      - name: Atualizar Pre√ßos Di√°rios e Sincronizar A√ß√µes
        id: atualizar_precos
        continue-on-error: true
        run: |
          echo "=========================================="
          echo "ATUALIZA√á√ÉO DE PRE√áOS DI√ÅRIOS"
          echo "=========================================="
          echo "Esta etapa:"
          echo "1. Baixa pre√ßo atual do Yahoo Finance"
          echo "2. Atualiza precos_trimestrais.csv"
          echo "3. Sincroniza acoes_historico.csv (copia √∫ltimo per√≠odo)"
          echo "4. Garante que m√∫ltiplos de valuation ser√£o calculados"
          echo ""
          python src/atualizar_precos_diarios.py --modo lista --lista "${TICKERS}"

      # ========================================================================
      # M√öLTIPLOS (COM PRE√áOS E A√á√ïES SINCRONIZADOS)
      # ========================================================================
      
      - name: Calcular M√∫ltiplos
        id: multiplos
        continue-on-error: true
        run: |
          python src/calcular_multiplos.py --modo lista --lista "${TICKERS}"

      # ========================================================================
      # RESUMO DE EXECU√á√ÉO
      # ========================================================================
      
      - name: Resumo de execu√ß√£o
        if: always()
        run: |
          echo "======================================================================"
          echo "                    RESUMO DO PIPELINE"
          echo "======================================================================"
          echo "Setor selecionado: ${{ inputs.setor }}"
          echo "Total de tickers:  ${TICKERS_COUNT}"
          echo "Limite aplicado:   ${{ inputs.limite }} (0 = todos)"
          echo "======================================================================"
          echo ""
          echo "Status por etapa (success/failure/skipped):"
          echo ""
          echo "üìä CAPTURAS:"
          echo "  - Balan√ßos:              ${{ steps.balancos.outcome }}"
          echo "  - Dividendos:            ${{ steps.dividendos.outcome }}"
          echo "  - A√ß√µes:                 ${{ steps.acoes.outcome }}"
          echo "  - Acionistas:            ${{ steps.acionistas.outcome }}"
          echo "  - Logos:                 ${{ steps.logos.outcome }}"
          echo ""
          echo "üîÑ PADRONIZA√á√ïES:"
          echo "  - DRE:                   ${{ steps.dre.outcome }}"
          echo "  - DFC:                   ${{ steps.dfc.outcome }}"
          echo "  - BP (BPA + BPP):        ${{ steps.bp.outcome }}"
          echo ""
          echo "üí∞ PRE√áOS:"
          echo "  - Hist√≥rico Completo:    ${{ steps.precos_historico.outcome }}"
          echo "  - Atualiza√ß√£o Di√°ria:    ${{ steps.atualizar_precos.outcome }}"
          echo ""
          echo "üìà M√öLTIPLOS:"
          echo "  - C√°lculo Final:         ${{ steps.multiplos.outcome }}"
          echo ""
          echo "======================================================================"
          
          # Verificar se alguma etapa cr√≠tica falhou
          critical_failed=0
          
          if [ "${{ steps.balancos.outcome }}" = "failure" ]; then
            echo "‚ö†Ô∏è  ATEN√á√ÉO: Captura de balan√ßos falhou (etapa cr√≠tica)"
            critical_failed=1
          fi
          
          if [ "${{ steps.dre.outcome }}" = "failure" ]; then
            echo "‚ö†Ô∏è  ATEN√á√ÉO: Padroniza√ß√£o DRE falhou (etapa cr√≠tica)"
            critical_failed=1
          fi
          
          if [ "${{ steps.multiplos.outcome }}" = "failure" ]; then
            echo "‚ö†Ô∏è  ATEN√á√ÉO: C√°lculo de m√∫ltiplos falhou (etapa cr√≠tica)"
            critical_failed=1
          fi
          
          if [ $critical_failed -eq 0 ]; then
            echo "‚úÖ Pipeline executado com sucesso!"
          else
            echo "‚ö†Ô∏è  Pipeline conclu√≠do com avisos (verifique etapas cr√≠ticas acima)"
          fi
          echo "======================================================================"

      # ========================================================================
      # COMMIT E PUSH
      # ========================================================================
      
      - name: Commit e push dos resultados
        if: always()
        run: |
          git config user.name "actions-user"
          git config user.email "actions-user@users.noreply.github.com"

          if [ -z "$(git status --porcelain)" ]; then
            echo "‚úÖ Nenhuma altera√ß√£o para commitar."
            exit 0
          fi

          # Mostrar resumo das mudan√ßas
          echo "======================================================================"
          echo "Arquivos modificados:"
          git status --short
          echo "======================================================================"

          git add -A
          
          # Mensagem de commit mais descritiva
          commit_msg="Pipeline: ${{ inputs.setor }} | Tickers: ${TICKERS_COUNT}"
          
          if [ "${{ inputs.limite }}" != "0" ]; then
            commit_msg="${commit_msg} | Limite: ${{ inputs.limite }}"
          fi
          
          git commit -m "${commit_msg}"
          git push
          
          echo "‚úÖ Altera√ß√µes commitadas e enviadas ao reposit√≥rio"
